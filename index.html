<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Analisis STEM Tingkatan 3 - 2025 (Edisi GitHub Host)</title>
    <!-- Library Graf & UI -->
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root { --primary-color: #1a73e8; --secondary-color: #34a853; --bg-color: #f8f9fa; }
        body { background-color: var(--bg-color); font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; color: #333; }
        
        /* Header & Penyesuaian Saiz Kotak Tajuk (Full Width) */
        .dashboard-header { padding: 30px 0; }
        .main-title-box {
            background: linear-gradient(135deg, #1a73e8, #0d47a1);
            color: white;
            padding: 30px 30px 10px 30px; 
            border-radius: 15px;
            width: 100%; 
            margin: 0 auto;
            box-shadow: 0 10px 25px rgba(26, 115, 232, 0.2);
            border-bottom: 6px solid #ffca28;
            text-align: center;
            position: relative;
        }

        .dev-credit-top {
            font-size: 0.55rem;
            font-weight: 400; 
            text-transform: uppercase;
            letter-spacing: 0.3px;
            opacity: 0.85;
            text-align: right;
            margin-top: 12px;
        }
        
        /* Cards & Warna */
        .card { border: none; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 25px; transition: all 0.3s; }
        .stat-card { text-align: center; padding: 15px; border-top: 5px solid #ccc; height: 100%; }
        
        /* Warna Dinamik untuk Kotak Statistik */
        .card-layak { border-top-color: #2e7d32 !important; }
        .card-near { border-top-color: #1a73e8 !important; } 
        .card-layak-tak-cenderung { border-top-color: #8e44ad !important; } 
        .card-ri { border-top-color: #c62828 !important; }
        .card-bukan { border-top-color: #757575 !important; }
        .card-total { border-top-color: var(--primary-color) !important; }

        .stat-value { font-size: 1.6rem; font-weight: 800; color: #555; display: block; }
        .stat-percentage { font-size: 0.85rem; font-weight: 700; color: #666; display: block; margin-top: -5px; }
        .stat-label { color: #555; font-size: 0.65rem; text-transform: uppercase; font-weight: bold; margin-top: 8px; display: block; line-height: 1.2; }
        
        /* Interactive List */
        .chart-title { font-weight: 700; color: #1a73e8; margin-bottom: 15px; border-left: 6px solid #ffca28; padding-left: 15px; font-size: 1.1rem; }
        
        /* Gaya Scrollbar Jelas & Berfungsi */
        .scroll-area { 
            max-height: 380px !important; 
            overflow-y: scroll !important; /* Paksa muncul */
            padding-right: 10px;
            scrollbar-width: thin;
            scrollbar-color: #666 #eee;
        }

        /* Custom Scrollbar Chrome/Edge/Safari */
        .scroll-area::-webkit-scrollbar {
            width: 10px;
            display: block !important;
        }
        .scroll-area::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .scroll-area::-webkit-scrollbar-thumb {
            background: #666; /* Warna gelap supaya nampak */
            border-radius: 10px;
            border: 2px solid #f1f1f1;
        }
        .scroll-area::-webkit-scrollbar-thumb:hover {
            background: #1a73e8;
        }
        
        .category-item { 
            padding: 10px 15px; 
            margin-bottom: 6px; 
            background: #fff; 
            border: 1px solid #dee2e6; 
            border-radius: 10px; 
            cursor: pointer; 
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .category-item:hover { background: #e8f0fe; color: #1a73e8; transform: translateX(3px); }
        .category-item.active { background: #1a73e8; color: #fff; border-color: #1a73e8; }
        
        /* Tables & Sticky Headers */
        .table-container { background: white; border-radius: 12px; overflow: hidden; border: 1px solid #eee; }
        
        /* Pastikan table container mengikut had scroll-area */
        #schoolTableContainer {
            max-height: 380px !important;
        }

        .table thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: inset 0 -1px 0 rgba(0,0,0,0.1);
        }
        
        .table:not(.table-dark) thead th {
            background-color: #f8f9fa;
            color: #333;
        }

        .table thead.table-dark th {
            background-color: #212529 !important;
            color: white !important;
        }

        .table td, .table th {
            white-space: nowrap;
            vertical-align: middle;
        }

        .student-detail-panel { background: #fff; border-radius: 15px; border: 2px solid #1a73e8; display: none; margin-top: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        .interactive-chart { cursor: pointer; }
        .footer { padding: 40px 0; color: #888; text-align: center; font-size: 0.85rem; position: relative; }
        .btn-export { background-color: #34a853; color: white; font-weight: bold; }
        
        .credits-box {
            background-color: #e8f0fe;
            color: #0d47a1;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 700;
            display: inline-block;
            border: 1px solid #1a73e8;
        }
        .credits-container {
            text-align: right;
            padding: 20px 0;
        }

        .school-detail-box {
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
        }

        .school-category-card {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            transition: all 0.2s;
            height: 100%;
        }
        .school-category-card:hover { border-color: #1a73e8; background: #f8faff; }
        .sch-cat-label { font-size: 0.7rem; font-weight: 700; color: #666; text-transform: uppercase; margin-bottom: 5px; line-height: 1.1; }
        .sch-cat-count { font-size: 1.1rem; font-weight: 800; color: #1a73e8; }
        .sch-cat-perc { font-size: 0.75rem; font-weight: 600; color: #888; }
    </style>
</head>
<body>

<div class="dashboard-header text-center">
    <div class="container">
        <div class="main-title-box">
            <h1 class="fw-bold mb-1" style="font-size: 2rem;">Analisis MP STEM dan IMK Tingkatan 3</h1>
            <p class="lead mb-0 opacity-75" style="font-size: 1.1rem;">Sistem Analisis Interaktif (PBD dan IMK)</p>
            <div class="dev-credit-top">
                APLIKASI INI DIBANGUNKAN OLEH UNIT TMK, SEKTOR PEMBELAJARAN, JPN PAHANG
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Langkah 1: Pengurusan Data -->
    <div class="card p-4 mb-4" style="border: 2px dashed #1a73e8; background-color: #fff;">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="chart-title mb-0">1. Pengurusan Data (GitHub / Drive / Manual)</h5>
            <button class="btn btn-sm btn-outline-danger fw-bold" onclick="resetFilters()">ðŸ”„ RESET DATA</button>
        </div>
        <p class="small text-muted mb-3">Sistem akan cuba mencari fail <strong>data.xlsx</strong> dalam GitHub secara automatik. Anda juga boleh memuat naik fail secara manual jika perlu.</p>
        <div class="input-group">
            <input type="file" class="form-control" id="excelInput" accept=".csv, .xlsx">
            <button class="btn btn-primary fw-bold" type="button" id="loadBtn">ANALISIS MANUAL</button>
        </div>
        <div id="uploadStatus" class="mt-2 small fw-bold text-muted">Memeriksa fail data...</div>
    </div>

    <!-- Statistik Utama -->
    <div class="row g-2 mb-4 text-center" id="summaryStats">
        <div class="col-6 col-md-2"><div class="card stat-card" id="card-total"><span class="stat-value" id="stat-total">0</span><span class="stat-percentage" id="perc-total">100%</span><span class="stat-label">Jumlah Murid</span></div></div>
        <div class="col-6 col-md-2"><div class="card stat-card" id="card-layak"><span class="stat-value" id="stat-layak">0</span><span class="stat-percentage" id="perc-layak">-</span><span class="stat-label">Layak STEM</span></div></div>
        <div class="col-6 col-md-2"><div class="card stat-card" id="card-near"><span class="stat-value" id="stat-near">0</span><span class="stat-percentage" id="perc-near">-</span><span class="stat-label">Near Miss</span></div></div>
        <div class="col-6 col-md-2"><div class="card stat-card" id="card-layak-tak-cenderung"><span class="stat-value" id="stat-layak-tak-cenderung">0</span><span class="stat-percentage" id="perc-layak-tak-cenderung">-</span><span class="stat-label">Layak STEM (Tak Cenderung)</span></div></div>
        <div class="col-6 col-md-2"><div class="card stat-card" id="card-ri"><span class="stat-value" id="stat-ri">0</span><span class="stat-percentage" id="perc-ri">-</span><span class="stat-label">Cenderung STEM (R+I)</span></div></div>
        <div class="col-6 col-md-2"><div class="card stat-card" id="card-bukan"><span class="stat-value" id="stat-bukan">0</span><span class="stat-percentage" id="perc-bukan">-</span><span class="stat-label">Bukan STEM</span></div></div>
    </div>

    <!-- Bahagian Utama -->
    <div class="row">
        <div class="col-lg-4">
            <div class="card p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="chart-title mb-0">2. Tapis Kategori</h5>
                </div>
                <div class="scroll-area">
                    <ul class="list-unstyled" id="mappingMenu">
                        <li class="text-muted small p-3 text-center">Menunggu data...</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="col-lg-8">
            <div class="card p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="chart-title mb-0">3. Sekolah & Bilangan Murid</h5>
                    <div id="filterIndicator" class="badge bg-primary px-3 py-2">Tiada Data</div>
                </div>
                
                <!-- Kontena Jadual - DIPERBAIKI UNTUK SKROL -->
                <div class="table-container scroll-area" id="schoolTableContainer">
                    <table class="table table-hover align-middle mb-0">
                        <thead>
                            <tr>
                                <th style="min-width: 70%;">Nama Institusi (Klik untuk senarai nama)</th>
                                <th class="text-center">Bil. Murid</th>
                            </tr>
                        </thead>
                        <tbody id="schoolTableBody">
                            <tr><td colspan="2" class="text-center text-muted py-5">Memproses data...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div id="totalSchoolCount" class="small fw-bold text-primary"></div>
                    <button id="exportBtn" class="btn btn-export btn-sm" style="display:none;" onclick="exportFilteredData()">ðŸ“¥ Eksport Excel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Perincian Murid (Pop-up Senarai Murid) -->
    <div id="studentDetailSection" class="student-detail-panel p-4 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0 fw-bold" id="studentTableTitle">Senarai Murid</h5>
            <div class="d-flex gap-2">
                <input type="text" id="studentSearch" class="form-control form-control-sm" placeholder="Cari Nama/KP..." onkeyup="searchInStudentTable()">
                <button class="btn btn-close" onclick="closeStudentSection()"></button>
            </div>
        </div>
        <div class="table-responsive" style="max-height: 400px; border: 1px solid #dee2e6; border-radius: 8px;">
            <table class="table table-sm table-bordered table-striped mb-0" id="mainStudentTable">
                <thead class="table-dark">
                    <tr>
                        <th class="py-2">Nama Murid</th>
                        <th class="py-2">No. KP</th>
                        <th class="py-2 text-center">Jantina</th>
                        <th class="py-2">Keputusan PB</th>
                        <th class="py-2">Status UASA</th>
                        <th class="py-2 text-center">IMK</th>
                    </tr>
                </thead>
                <tbody id="studentTableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Graf Visual Interaktif -->
    <div class="row">
        <div class="col-md-6">
            <div class="card p-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="chart-title mb-0">Analisis mengikut PPD (Klik Bar)</h5>
                    <button class="btn btn-xs btn-outline-secondary" style="font-size: 0.6rem; padding: 2px 5px;" onclick="resetFilters()">Reset PPD</button>
                </div>
                <div id="ppdBarChart" class="interactive-chart" style="height: 400px;"></div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card p-4">
                <h5 class="chart-title">Profil Minat IMK (Klik Bar)</h5>
                <div id="imkChart" class="interactive-chart" style="height: 400px;"></div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="card p-4 text-center">
                <h5 class="chart-title">Taburan Jantina (Klik)</h5>
                <div id="genderChart" class="interactive-chart" style="height: 300px;"></div>
            </div>
        </div>
        <div class="col-md-8">
            <div class="card p-4">
                <h5 class="chart-title">Pencapaian Akademik UASA (Klik Bar)</h5>
                <div id="uasaFullChart" class="interactive-chart" style="height: 300px;"></div>
            </div>
        </div>
    </div>

    <!-- Langkah 4: ANALISIS PERINCIAAN SEKOLAH -->
    <div class="card p-4 mb-4" id="sectionDetailSekolah">
        <h5 class="chart-title">4. Analisis Perincian Sekolah</h5>
        <div class="row g-3 mb-4">
            <div class="col-md-6">
                <label class="small fw-bold mb-1">Pilih PPD:</label>
                <select id="ppdFilter" class="form-select" onchange="updateSchoolDropdown()">
                    <option value="">-- SEMUA PPD --</option>
                </select>
            </div>
            <div class="col-md-6">
                <label class="small fw-bold mb-1">Pilih Sekolah:</label>
                <select id="schoolFilter" class="form-select" onchange="showDetailedSchoolStats()">
                    <option value="">-- PILIH SEKOLAH --</option>
                </select>
            </div>
        </div>

        <div id="schoolDetailContent" style="display:none;">
            <div class="school-detail-box">
                <!-- Statistik Ringkas Sekolah -->
                <div class="row g-2 mb-4 text-center" id="schoolResultStats">
                    <!-- Stats dijana di sini -->
                </div>

                <!-- Taburan Kategori Sekolah - Visual Seragam -->
                <div class="mb-4">
                    <h6 class="fw-bold mb-3 small text-primary" id="distributionTitle">Taburan Mengikut Kategori (Pemetaan IMK & UASA)</h6>
                    <div id="schoolCategoryDistribution" class="row row-cols-2 row-cols-md-4 row-cols-lg-6 g-2">
                        <!-- Kad kategori dijana di sini -->
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-2 mt-4">
                    <h6 class="fw-bold mb-0" id="listTitle">Senarai Murid Institusi</h6>
                    <button class="btn btn-success btn-sm fw-bold" onclick="exportSchoolSpecificData()">ðŸ“¥ Eksport Excel Senarai</button>
                </div>
                <div class="table-responsive" style="max-height: 400px; border: 1px solid #dee2e6; border-radius: 8px;">
                    <table class="table table-sm table-striped table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th class="py-2">Nama Murid</th>
                                <th class="py-2 text-center">Jantina</th>
                                <th class="py-2">Keputusan PB</th>
                                <th class="py-2">UASA</th>
                                <th class="py-2 text-center">IMK</th>
                            </tr>
                        </thead>
                        <tbody id="schoolDetailTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Credits Box Bottom -->
    <div class="credits-container">
        <div class="credits-box">
            APLIKASI INI DIBANGUNKAN OLEH UNIT TMK, SEKTOR PEMBELAJARAN JPN PAHANG 2026
        </div>
    </div>
</div>

<footer class="footer">
    <p>Sistem Analisis Interaktif (PBD dan IMK)</p>
</footer>

<script>
    const GITHUB_FILENAME = 'data.xlsx'; 
    const GOOGLE_DRIVE_FILE_ID = 'MASUKKAN_FILE_ID_DI_SINI'; 

    let fullData = [];
    let currentFilteredData = [];

    function initDashboard() {
        try {
            Plotly.newPlot('genderChart', [{ labels: ['Menunggu...'], values: [1], type: 'pie', marker: {colors:['#eee']} }], { margin: {t:0,b:0,l:0,r:0} });
            Plotly.newPlot('imkChart', [{ x: ['A','E','I','K','R','S'], y: [0,0,0,0,0,0], type: 'bar', marker: {color:'#ccc'} }], { margin: {t:20,b:30,l:30,r:10} });
            Plotly.newPlot('ppdBarChart', [{ y: ['-'], x: [0], type: 'bar', orientation: 'h', marker: {color:'#ccc'} }], { margin: {t:10,b:30,l:100,r:20} });
            Plotly.newPlot('uasaFullChart', [{ y: ['-'], x: [0], type: 'bar', orientation: 'h', marker: {color:['#ccc']} }], { margin: {t:10,b:30,l:120,r:20} });
            
            setupClickEvents();
            tryAutoFetch();
        } catch (e) {
            console.error("Ralat init graf:", e);
        }
    }

    async function tryAutoFetch() {
        const statusEl = document.getElementById('uploadStatus');
        statusEl.innerHTML = "ðŸ” Mencari fail data di GitHub...";
        
        try {
            const githubRes = await fetch(GITHUB_FILENAME);
            if (githubRes.ok) {
                const data = await githubRes.arrayBuffer();
                processExcelData(data);
                statusEl.innerHTML = `âœ… Data berjaya ditarik dari GitHub (${GITHUB_FILENAME}).`;
                statusEl.className = "mt-2 small fw-bold text-success";
                return;
            }
        } catch (e) { console.log("Fail GitHub tidak dijumpai."); }

        if (GOOGLE_DRIVE_FILE_ID !== 'MASUKKAN_FILE_ID_DI_SINI') {
            statusEl.innerHTML = "ðŸ”„ GitHub tiada data, cuba Google Drive...";
            fetchFromGoogleDrive(GOOGLE_DRIVE_FILE_ID);
        } else {
            statusEl.innerHTML = "Sedia. Sila muat naik fail manual atau letakkan fail 'data.xlsx' di GitHub.";
        }
    }

    async function fetchFromGoogleDrive(fileId) {
        const url = `https://docs.google.com/spreadsheets/d/${fileId}/export?format=xlsx`;
        const statusEl = document.getElementById('uploadStatus');
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Gagal akses Google Drive.');
            const data = await response.arrayBuffer();
            processExcelData(data);
            statusEl.innerHTML = "âœ… Data berjaya ditarik dari Google Drive.";
            statusEl.className = "mt-2 small fw-bold text-success";
        } catch (error) {
            statusEl.innerHTML = "Sedia. Sila muat naik fail manual.";
        }
    }

    function processExcelData(dataBuffer) {
        try {
            const workbook = XLSX.read(dataBuffer, {type: 'array'});
            fullData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            fullData = fullData.map(row => {
                let r = {};
                Object.keys(row).forEach(k => r[k.trim()] = row[k]);
                return r;
            });

            ['total', 'layak', 'near', 'layak-tak-cenderung', 'ri', 'bukan'].forEach(id => {
                const card = document.getElementById('card-' + id);
                if(card) card.classList.add('card-' + id);
            });
            
            processData();
            populatePPDDropdown(); 
        } catch (e) {
            console.error("Ralat memproses excel:", e);
        }
    }

    function setupClickEvents() {
        const gc = document.getElementById('genderChart');
        const ic = document.getElementById('imkChart');
        const pc = document.getElementById('ppdBarChart');
        const uc = document.getElementById('uasaFullChart');

        if(gc) gc.on('plotly_click', (d) => { if(fullData.length) handleInteraction('JANTINA', d.points[0].label === 'Lelaki' ? 'L' : 'P', `Jantina: ${d.points[0].label}`); });
        if(ic) ic.on('plotly_click', (d) => { if(fullData.length) handleInteraction('KOD IMK', d.points[0].x, `IMK: ${d.points[0].x}`); });
        if(pc) pc.on('plotly_click', (d) => { if(fullData.length) handleInteraction('KET_PPD', d.points[0].y, `PPD: ${d.points[0].y}`); });
        if(uc) uc.on('plotly_click', (d) => { if(fullData.length) handleInteraction('STATUS UASA', d.points[0].y, `UASA: ${d.points[0].y}`); });
    }

    document.getElementById('loadBtn').addEventListener('click', () => {
        const file = document.getElementById('excelInput').files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            processExcelData(e.target.result);
            const statusEl = document.getElementById('uploadStatus');
            statusEl.innerHTML = `âœ… Analisis fail manual berjaya (${fullData.length.toLocaleString()} rekod).`;
            statusEl.className = "mt-2 small fw-bold text-success";
        };
        reader.readAsArrayBuffer(file);
    });

    function processData() {
        const mappingCounts = {};
        fullData.forEach(d => {
            const lbl = String(d['PEMETAAN IMK DAN UASA'] || 'TIADA DATA').trim();
            mappingCounts[lbl] = (mappingCounts[lbl] || 0) + 1;
        });

        const menu = document.getElementById('mappingMenu');
        menu.innerHTML = "";
        
        // 1. Tambah butang dinamik asal
        Object.entries(mappingCounts).sort((a,b) => b[1] - a[1]).forEach(([label, count]) => {
            const li = document.createElement('li');
            li.className = 'category-item';
            const perc = ((count/fullData.length)*100).toFixed(1);
            li.innerHTML = `<span>${label}</span> <span><span class="badge bg-primary rounded-pill me-1">${count.toLocaleString()}</span> <small class="text-muted">${perc}%</small></span>`;
            li.onclick = () => {
                document.querySelectorAll('.category-item').forEach(i => i.classList.remove('active'));
                li.classList.add('active');
                handleInteraction('PEMETAAN IMK DAN UASA', label);
            };
            menu.appendChild(li);
        });

        // 2. Tambah butang KHAS: Sekolah Kritikal Murid STEM
        const specialLi = document.createElement('li');
        specialLi.className = 'category-item mt-3 border-danger';
        specialLi.innerHTML = `<span><strong class="text-danger">Sekolah Kritikal Murid STEM</strong><br><small class="text-muted">(Sains & Mat. Bawah Gred C)</small></span>`;
        specialLi.onclick = () => {
            document.querySelectorAll('.category-item').forEach(i => i.classList.remove('active'));
            specialLi.classList.add('active');
            filterSchoolsWithNoLayak();
        };
        menu.appendChild(specialLi);

        currentFilteredData = [...fullData];
        updateDashboardVisuals("Semua Data");
    }

    // Fungsi baharu untuk tapis sekolah yang langsung tiada murid LAYAK
    function filterSchoolsWithNoLayak() {
        if (fullData.length === 0) return;
        
        // Kenalpasti sekolah yang ada sekurang-kurangnya seorang LAYAK
        const schoolsWithLayak = new Set();
        fullData.forEach(d => {
            if (String(d['STATUS UASA'] || '').toUpperCase().includes('LAYAK')) {
                schoolsWithLayak.add(d['NAMA_PENUH_INSTITUSI']);
            }
        });

        // Tapis murid dari sekolah yang TIADA dalam senarai schoolsWithLayak
        currentFilteredData = fullData.filter(d => !schoolsWithLayak.has(d['NAMA_PENUH_INSTITUSI']));
        
        updateDashboardVisuals("Sekolah Kritikal Murid STEM");
    }

    function handleInteraction(col, val, displayLabel) {
        if (fullData.length === 0) return;
        currentFilteredData = fullData.filter(d => String(d[col] || '').trim().includes(String(val).trim()));
        updateDashboardVisuals(displayLabel || val);
    }

    function updateDashboardVisuals(label) {
        document.getElementById('filterIndicator').innerText = label;
        const total = currentFilteredData.length;
        const layak = currentFilteredData.filter(d => String(d['STATUS UASA'] || '').includes('LAYAK')).length;
        const near = currentFilteredData.filter(d => String(d['STATUS UASA'] || '').includes('NEAR MISS')).length;
        const ri = currentFilteredData.filter(d => ['R','I'].includes(d['KOD IMK'])).length;
        const bukan = total - ri;
        const layakTakCenderung = currentFilteredData.filter(d => String(d['STATUS UASA'] || '').includes('LAYAK') && !['R','I'].includes(d['KOD IMK'])).length;

        document.getElementById('stat-total').innerText = total.toLocaleString();
        document.getElementById('stat-layak').innerText = layak.toLocaleString();
        document.getElementById('perc-layak').innerText = total > 0 ? ((layak/total)*100).toFixed(1)+'%' : '0%';
        document.getElementById('stat-near').innerText = near.toLocaleString();
        document.getElementById('perc-near').innerText = total > 0 ? ((near/total)*100).toFixed(1)+'%' : '0%';
        document.getElementById('stat-layak-tak-cenderung').innerText = layakTakCenderung.toLocaleString();
        document.getElementById('perc-layak-tak-cenderung').innerText = total > 0 ? ((layakTakCenderung/total)*100).toFixed(1)+'%' : '0%';
        document.getElementById('stat-ri').innerText = ri.toLocaleString();
        document.getElementById('perc-ri').innerText = total > 0 ? ((ri/total)*100).toFixed(1)+'%' : '0%';
        document.getElementById('stat-bukan').innerText = bukan.toLocaleString();
        document.getElementById('perc-bukan').innerText = total > 0 ? ((bukan/total)*100).toFixed(1)+'%' : '0%';

        try {
            const l = currentFilteredData.filter(d => d.JANTINA === 'L').length;
            const p = currentFilteredData.filter(d => d.JANTINA === 'P').length;
            Plotly.restyle('genderChart', { labels: [['Perempuan', 'Lelaki']], values: [[p, l]], marker: {colors: [['#f06292', '#42a5f5']]}, textinfo: 'label+value+percent' });

            const imk = { 'A':0, 'E':0, 'I':0, 'K':0, 'R':0, 'S':0 };
            currentFilteredData.forEach(d => { if(imk[d['KOD IMK']] !== undefined) imk[d['KOD IMK']]++; });
            const imkKeys = Object.keys(imk);
            const imkColors = imkKeys.map(k => (k === 'I' || k === 'R') ? '#1a73e8' : '#ff9800');
            Plotly.restyle('imkChart', { 
                y: [Object.values(imk)], 
                x: [imkKeys], 
                text: [Object.values(imk)], 
                'marker.color': [imkColors] 
            });

            const ppdCounts = {};
            currentFilteredData.forEach(d => { const p = String(d['KET_PPD'] || 'TIADA PPD').trim(); ppdCounts[p] = (ppdCounts[p] || 0) + 1; });
            const sortedPPD = Object.entries(ppdCounts).sort((a,b) => a[1] - b[1]);
            Plotly.restyle('ppdBarChart', { y: [sortedPPD.map(x => x[0])], x: [sortedPPD.map(x => x[1])], text: [sortedPPD.map(x => x[1])], marker: {color: '#34a853'} });

            const uCounts = { 'LAYAK':0, 'NEAR MISS':0, 'TIDAK MELEPASI':0, 'TIADA DATA':0 };
            currentFilteredData.forEach(d => {
                const s = String(d['STATUS UASA'] || '').toUpperCase();
                if(s.includes('TIDAK MELEPASI')) uCounts['TIDAK MELEPASI']++; 
                else if(s.includes('LAYAK')) uCounts['LAYAK']++; 
                else if(s.includes('NEAR MISS')) uCounts['NEAR MISS']++; 
                else uCounts['TIADA DATA']++;
            });
            Plotly.restyle('uasaFullChart', { y: [Object.keys(uCounts)], x: [Object.values(uCounts)], text: [Object.values(uCounts)], 'marker.color': [['#2e7d32', '#1a73e8', '#c62828', '#757575']] });
        } catch (e) {}

        const schools = {};
        currentFilteredData.forEach(d => { const s = d['NAMA_PENUH_INSTITUSI'] || 'Tidak Diketahui'; schools[s] = (schools[s] || 0) + 1; });
        const sortedSchools = Object.entries(schools).sort((a,b) => b[1] - a[1]);
        let html = sortedSchools.map(([name, count]) => `<tr onclick="showStudents('${name.replace(/'/g, "\\'")}')" style="cursor:pointer;"><td class="small fw-semibold">${name} <span class="text-primary small">âž”</span></td><td class="text-center"><span class="badge bg-primary px-3">${count}</span></td></tr>`).join('');
        document.getElementById('schoolTableBody').innerHTML = html || '<tr><td colspan="2" class="text-center py-4">Tiada rekod.</td></tr>';
        document.getElementById('totalSchoolCount').innerText = `${total.toLocaleString()} Murid | ${sortedSchools.length} Sekolah`;
        document.getElementById('exportBtn').style.display = 'block';
        
        const schoolContainer = document.getElementById('schoolTableContainer');
        if(schoolContainer) schoolContainer.scrollTop = 0;
        closeStudentSection();
    }

    function showStudents(schoolName) {
        const list = currentFilteredData.filter(d => d['NAMA_PENUH_INSTITUSI'] === schoolName);
        document.getElementById('studentTableTitle').innerText = `${schoolName} (${list.length})`;
        let html = list.map(s => `<tr><td class="small">${s['NAMA_MURID'] || '-'}</td><td class="small">${s['NO_KP'] || '-'}</td><td class="text-center small">${s['JANTINA'] || '-'}</td><td class="small">${s['PB'] || '-'}</td><td class="small">${s['STATUS UASA'] || '-'}</td><td class="text-center fw-bold small">${s['KOD IMK'] || '-'}</td></tr>`).join('');
        document.getElementById('studentTableBody').innerHTML = html;
        document.getElementById('studentDetailSection').style.display = 'block';
        document.getElementById('studentDetailSection').scrollIntoView({ behavior: 'smooth' });
    }

    function populatePPDDropdown() {
        const ppdSet = new Set();
        fullData.forEach(d => { if(d['KET_PPD']) ppdSet.add(d['KET_PPD']); });
        const ppdFilter = document.getElementById('ppdFilter');
        ppdFilter.innerHTML = '<option value="">-- SEMUA PPD --</option>';
        [...ppdSet].sort().forEach(ppd => {
            const opt = document.createElement('option');
            opt.value = ppd;
            opt.textContent = ppd;
            ppdFilter.appendChild(opt);
        });
        updateSchoolDropdown();
    }

    function updateSchoolDropdown() {
        const ppdVal = document.getElementById('ppdFilter').value;
        const schoolSet = new Set();
        
        // Reset schoolSpecificData jika PPD dipilih supaya ia paparkan data PPD
        schoolSpecificData = [];

        fullData.forEach(d => {
            if(!ppdVal || d['KET_PPD'] === ppdVal) {
                if(d['NAMA_PENUH_INSTITUSI']) schoolSet.add(d['NAMA_PENUH_INSTITUSI']);
                if(ppdVal && d['KET_PPD'] === ppdVal) schoolSpecificData.push(d);
            }
        });

        const schoolFilter = document.getElementById('schoolFilter');
        schoolFilter.innerHTML = '<option value="">-- PILIH SEKOLAH --</option>';
        [...schoolSet].sort().forEach(sch => {
            const opt = document.createElement('option');
            opt.value = sch;
            opt.textContent = sch;
            schoolFilter.appendChild(opt);
        });

        if (ppdVal && schoolSpecificData.length > 0) {
            document.getElementById('distributionTitle').innerText = `Taburan Mengikut Kategori PPD: ${ppdVal}`;
            document.getElementById('listTitle').innerText = `Senarai Murid Keseluruhan PPD: ${ppdVal}`;
            renderDetailedStats(schoolSpecificData);
            document.getElementById('schoolDetailContent').style.display = 'block';
        } else {
            document.getElementById('schoolDetailContent').style.display = 'none';
        }
    }

    let schoolSpecificData = [];

    // Fungsi Pembantu untuk menjana visual perincian (PPD atau Sekolah)
    function renderDetailedStats(data) {
        const total = data.length;
        if (total === 0) return;

        const layak = data.filter(d => String(d['STATUS UASA'] || '').includes('LAYAK')).length;
        const ri = data.filter(d => ['R','I'].includes(d['KOD IMK'])).length;

        // 1. Kemaskini Kad Statistik
        const statsHtml = `
            <div class="col-4"><div class="card stat-card card-total"><span class="stat-value" style="font-size:1.2rem">${total}</span><span class="stat-label">Jumlah Murid</span></div></div>
            <div class="col-4"><div class="card stat-card card-layak"><span class="stat-value" style="font-size:1.2rem">${layak} (${((layak/total)*100).toFixed(1)}%)</span><span class="stat-label">Layak STEM</span></div></div>
            <div class="col-4"><div class="card stat-card card-ri"><span class="stat-value" style="font-size:1.2rem">${ri} (${((ri/total)*100).toFixed(1)}%)</span><span class="stat-label">Minat R+I</span></div></div>
        `;
        document.getElementById('schoolResultStats').innerHTML = statsHtml;

        // 2. Kemaskini Taburan Kategori
        const mappingCounts = {};
        data.forEach(d => {
            const lbl = String(d['PEMETAAN IMK DAN UASA'] || 'TIADA DATA').trim();
            mappingCounts[lbl] = (mappingCounts[lbl] || 0) + 1;
        });

        const catDistEl = document.getElementById('schoolCategoryDistribution');
        catDistEl.innerHTML = "";
        Object.entries(mappingCounts).sort((a,b) => b[1] - a[1]).forEach(([label, count]) => {
            const perc = ((count/total)*100).toFixed(1);
            const col = document.createElement('div');
            col.className = 'col';
            col.innerHTML = `
                <div class="school-category-card">
                    <div class="sch-cat-label">${label}</div>
                    <div class="sch-cat-count">${count}</div>
                    <div class="sch-cat-perc">${perc}%</div>
                </div>
            `;
            catDistEl.appendChild(col);
        });

        // 3. Kemaskini Jadual Senarai Murid
        const tableBody = document.getElementById('schoolDetailTableBody');
        tableBody.innerHTML = data.map(s => `
            <tr>
                <td class="small fw-bold">${s['NAMA_MURID'] || '-'}</td>
                <td class="small text-center">${s['JANTINA'] || '-'}</td>
                <td class="small">${s['PB'] || '-'}</td>
                <td class="small">${s['STATUS UASA'] || '-'}</td>
                <td class="text-center fw-bold">${s['KOD IMK'] || '-'}</td>
            </tr>
        `).join('');
    }

    function showDetailedSchoolStats() {
        const schVal = document.getElementById('schoolFilter').value;
        if(!schVal) {
            // Jika sekolah tidak dipilih semula, paparkan data PPD semula
            updateSchoolDropdown();
            return;
        }

        document.getElementById('distributionTitle').innerText = `Taburan Mengikut Kategori Sekolah: ${schVal}`;
        document.getElementById('listTitle').innerText = `Senarai Murid Institusi: ${schVal}`;
        
        schoolSpecificData = fullData.filter(d => d['NAMA_PENUH_INSTITUSI'] === schVal);
        renderDetailedStats(schoolSpecificData);
        document.getElementById('schoolDetailContent').style.display = 'block';
    }

    function exportSchoolSpecificData() {
        if (!schoolSpecificData.length) return;
        const schName = document.getElementById('schoolFilter').value || document.getElementById('ppdFilter').value || "Analisis_Perincian";
        const ws = XLSX.utils.json_to_sheet(schoolSpecificData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Senarai");
        XLSX.writeFile(wb, `Analisis_STEM_${schName.substring(0,30)}.xlsx`);
    }

    function searchInStudentTable() {
        const input = document.getElementById('studentSearch').value.toUpperCase();
        const trs = document.getElementById('studentTableBody').getElementsByTagName('tr');
        for (let i = 0; i < trs.length; i++) {
            const text = trs[i].textContent || trs[i].innerText;
            trs[i].style.display = text.toUpperCase().indexOf(input) > -1 ? "" : "none";
        }
    }

    function exportFilteredData() {
        if (!currentFilteredData.length) return;
        const ws = XLSX.utils.json_to_sheet(currentFilteredData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Tapis");
        XLSX.writeFile(wb, "Analisis_STEM_Tapis.xlsx");
    }

    function resetFilters() { 
        document.querySelectorAll('.category-item').forEach(i => i.classList.remove('active'));
        currentFilteredData = [...fullData];
        updateDashboardVisuals("Semua Data");
        closeStudentSection();
        document.getElementById('ppdFilter').value = "";
        updateSchoolDropdown();
    }

    function closeStudentSection() { document.getElementById('studentDetailSection').style.display = 'none'; }

    window.onload = initDashboard;
</script>

</body>
</html>
